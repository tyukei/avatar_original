# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy Production
on:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: cd frontend && echo "VITE_WS_URL=${{ secrets.VITE_WS_URL }}" > .env && npm ci && npm run build
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}

  deploy_backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker to use gcloud as credential helper
        run: gcloud auth configure-docker

      - name: Build and push Docker image
        run: |
          cd backend
          docker build -t gcr.io/${{ secrets.FIREBASE_PROJECT_ID }}/avatar-backend:${{ github.sha }} .
          docker push gcr.io/${{ secrets.FIREBASE_PROJECT_ID }}/avatar-backend:${{ github.sha }}

      - name: Deploy to Cloud Run
        env:
          FIREBASE_SA: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          # Base64 encode the service account to avoid argument parsing issues
          FIREBASE_SA_BASE64=$(echo -n "$FIREBASE_SA" | base64 -w 0)
          
          gcloud run deploy avatar-backend \
            --image gcr.io/${{ secrets.FIREBASE_PROJECT_ID }}/avatar-backend:${{ github.sha }} \
            --platform managed \
            --region asia-northeast1 \
            --allow-unauthenticated \
            --set-env-vars GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }} \
            --set-env-vars FIREBASE_SERVICE_ACCOUNT=$FIREBASE_SA_BASE64 \
            --project ${{ secrets.FIREBASE_PROJECT_ID }}


  release:
    needs: [build_and_deploy, deploy_backend]
    runs-on: ubuntu-latest
    if: success()
    permissions:
      contents: write
      pull-requests: read
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version
        id: bump_version
        shell: bash
        run: |
          set -euo pipefail

          # pyproject.toml„Åã„Çâ„Éê„Éº„Ç∏„Éß„É≥„ÇíÂèñÂæó
          CURRENT_VERSION=$(grep -oP '^version = "\K[^"]+' backend/pyproject.toml)
          echo "Current version: $CURRENT_VERSION"

          NEW_VERSION=$(python3 -c "v='$CURRENT_VERSION'.split('.'); v[-1]=str(int(v[-1])+1); print('.'.join(v))")
          echo "New version: $NEW_VERSION"

          # pyproject.toml„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÇíÊõ¥Êñ∞
          sed -i 's/^version = "'$CURRENT_VERSION'"/version = "'$NEW_VERSION'"/' backend/pyproject.toml
          
          # frontend/package.json„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÇíÊõ¥Êñ∞
          sed -i 's/"version": "'$CURRENT_VERSION'"/"version": "'$NEW_VERSION'"/' frontend/package.json

          # frontend/index.html„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÇíÊõ¥Êñ∞
          sed -i 's/<meta name="version" content="'$CURRENT_VERSION'"/<meta name="version" content="'$NEW_VERSION'"/' frontend/index.html
          echo "VERSION=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Commit and push changes
        shell: bash
        run: |
          set -euo pipefail

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add backend/pyproject.toml frontend/package.json frontend/index.html
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: bump version to ${{ steps.bump_version.outputs.VERSION }} [skip ci]"
          git push

      - name: Generate AI Summary
        id: ai_summary
        if: env.GEMINI_API_KEY != ''
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "LAST_TAG=$LAST_TAG"

          # 1. PR„ÅÆ‰∏ÄË¶ß„ÇíÂèñÂæó
          if [ -n "$LAST_TAG" ]; then
            PRS=$(gh pr list --state merged --base main --limit 50 --json title --template '{{range .}}- {{.title}}{{"\n"}}{{end}}')
          else
            PRS=$(gh pr list --state merged --limit 20 --json title --template '{{range .}}- {{.title}}{{"\n"}}{{end}}')
          fi

          # 2. „Ç≥„Éü„ÉÉ„Éà„É≠„Ç∞„ÇíÂèñÂæóÔºà„Éû„Éº„Ç∏„Ç≥„Éü„ÉÉ„Éà‰ª•Â§ñÔºâ
          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log "${LAST_TAG}..HEAD" --oneline --no-merges | head -n 50)
          else
            COMMITS=$(git log --oneline --no-merges | head -n 20)
          fi

          # 3. ‰∏°Êñπ„ÇíÁµêÂêà„Åó„Å¶Êèê‰æõ
          CONTENT_LIST=$(cat <<EOF
          ### Merged Pull Requests:
          $PRS

          ### Commit Messages:
          $COMMITS
          EOF
          )

          if [ -z "${CONTENT_LIST// }" ]; then
            SUMMARY="- ÂÜÖÈÉ®ÊîπÂñÑÔºàË©≥Á¥∞„Å™„ÅóÔºâ"
          else
            export CONTENT_LIST
            SUMMARY="$(python3 .github/scripts/generate_release_summary.py)"
          fi

          # ‚úÖ ÊîπË°å„ÇíÊΩ∞„Åï„Åö„Å´ steps output „Å®„Åó„Å¶Ê∏°„Åô
          {
            echo "SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "PRS<<EOF"
            echo "$PRS"
            echo "EOF"
            echo "COMMITS<<EOF"
            echo "$COMMITS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump_version.outputs.VERSION }}
          body: |
            ## ‚ú® What's New
            ${{ steps.ai_summary.outputs.SUMMARY || '- ÂÜÖÈÉ®ÊîπÂñÑÔºàË©≥Á¥∞„Å™„ÅóÔºâ' }}

            ---
            ### üõ† Details
            #### Merged Pull Requests
            ${{ steps.ai_summary.outputs.PRS || '- No merged PRs' }}

            #### Commits
            ${{ steps.ai_summary.outputs.COMMITS || '- No direct commits' }}
          generate_release_notes: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete merged PR branches
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          PRS=$(gh pr list --state merged --base main --limit 50 \
            --json number,headRefName,headRepository \
            --jq '.[] | @base64')

          if [ -z "${PRS// }" ]; then
            echo "No merged PRs found."
            exit 0
          fi

          echo "$PRS" | while read -r row; do
            _jq() { echo "$row" | base64 --decode | jq -r "$1"; }

            pr_number=$(_jq '.number')
            branch=$(_jq '.headRefName')
            repo_full=$(_jq '.headRepository.nameWithOwner')

            # ‰øùË≠∑ÔºöÊ∂à„Åó„Åü„Åè„Å™„ÅÑ„Éñ„É©„É≥„ÉÅ
            if [[ "$branch" == "main" || "$branch" == "master" || "$branch" == "develop" || "$branch" == release/* ]]; then
              echo "Skip protected branch: $branch (PR #$pr_number)"
              continue
            fi

            # Êó¢„Å´Ê∂à„Åà„Å¶„Åü„Çâ„Çπ„Ç≠„ÉÉ„Éó
            if ! gh api -H "Accept: application/vnd.github+json" "/repos/$repo_full/git/ref/heads/$branch" >/dev/null 2>&1; then
              echo "Branch already deleted: $repo_full:$branch (PR #$pr_number)"
              continue
            fi

            echo "Deleting branch: $repo_full:$branch (PR #$pr_number)"
            gh api -X DELETE -H "Accept: application/vnd.github+json" "/repos/$repo_full/git/ref/heads/$branch" || true
          done
